/*! lib1self-client - v0.0.0 - 2015-01-26
* http://www.youtube.com/watch?v=cDuG95DXbw8
* Copyright (c) 2015 Obi-Wan Kenobi; Licensed  */
!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.Lib1selfClient=b()}(this,function(){"use strict";function a(a){window.latitude=a.coords.latitude,window.longitude=a.coords.longitude}function b(){navigator.geolocation?navigator.geolocation.getCurrentPosition(a):console.info("Geolocation is not supported by this browser.")}var c="http://sandbox.1self.co",d={sandbox:"http://sandbox.1self.co",production:"https://api.1self.co"},e=!1,f={},g=function(a){return JSON.parse(window.localStorage[a]||"{}")},h=function(){var a=g("1self");return"undefined"==typeof a.events&&(a.events=[]),a}(),i=function(a,b){window.localStorage[a]=JSON.stringify(b)},j=function(a){return a.dateTime||(a.dateTime=(new Date).toISOString()),a.source=f.appName,a.version=f.appVersion,!a.actionTags&&ACTION_TAGS.length>0&&(a.actionTags=ACTION_TAGS),!a.objectTags&&OBJECT_TAGS.length>0&&(a.objectTags=OBJECT_TAGS),"undefined"!=typeof window.latitude&&(a.location={lat:window.latitude,"long":window.longitude}),a},k=function(a){h.events.push(a),i("1self",h)},l=function(a,b){if(!e){var d=0;if("undefined"!=typeof f.streamid){var g=c+"/v1/streams/"+f.streamid+"/events/batch",j=new XMLHttpRequest;j.open("POST",g,!0);var k={Authorization:f.writeToken,"Content-Type":"application/json"},l=Object.keys(k);l.forEach(function(a){j.setRequestHeader(a,k[a])}),j.onload=function(){4==j.readyState&&200==j.status?(h.events=h.events.slice(d),i("1self",h),a&&a()):b&&b(),e=!1},j.onerror=function(){e=!1,b&&b()},d=h.events.length,d>0&&(e=!0,j.send(JSON.stringify(h.events.slice(0,d))))}}},m=function(a){var b=1e3,c=1e3,d=null,e=b,f=function(){l(function(){clearInterval(d),e=b,d=setInterval(f,e),a.onsendsuccess&&a.onsendsuccess()},function(){clearInterval(d),e+=c,d=setInterval(f,e),a.onsenderror&&a.onsenderror()})};d=setInterval(f,b)},n=function(a,e){if("undefined"==typeof a.appName)throw new Error("appName not configured");if("undefined"==typeof a.appVersion)throw new Error("appVersion not configured");if("undefined"==typeof a.appId)throw new Error("appId not configured");if("undefined"==typeof a.appSecret)throw new Error("appSecret not configured");e&&d[e]&&(c=d[e]),f=a,this.OBJECT_TAGS=[],this.ACTION_TAGS=[],this.BACKGROUND_COLOR="",this.onsendsuccess=null,this.onsenderror=null,window.localStorage["1self"]||i("1self",{events:[]});var h=g("config");return h.streamid&&(f.streamid=h.streamid),h.writeToken&&(f.writeToken=h.writeToken),window.addEventListener("load",b,!1),m(this),this};return n.prototype.registerStream=function(a){if(!f.appId||!f.appSecret)throw new Error("Set appId and appSecret");var b=new XMLHttpRequest;return b.open("POST",c+"/v1/streams",!0),b.setRequestHeader("Authorization",f.appId+":"+f.appSecret),b.onload=function(){if(4==b.readyState&&200==b.status){var c=JSON.parse(b.response);a(null,c)}else a(new Error(b.statusText))},b.onerror=function(){a(Error("Network Error"))},b.send(),this},n.prototype.sendEvent=function(a,b,c){if(!c||!b)throw new Error("streamid, writeToken needs to be specified");if("object"!=typeof a||"number"==typeof a.length)throw new Error("Event type error");return f.streamid=b,f.writeToken=c,i("config",f),j(a),k(a),l(this.onsendsuccess,this.onsenderror),this},n.prototype.sendEvents=function(a,b,c){if(!c)throw new Error("streamid, writeToken needs to be specified");if("object"!=typeof a||"undefined"==typeof a.length)throw new Error("Event type error");return a.forEach(function(a){j(a,f),k(a)}),f.streamid=b,f.writeToken=c,i("config",f),l(this.onsendsuccess,this.onsenderror),this},n.prototype.backgroundColor=function(a){return this.BACKGROUND_COLOR=a,this},n.prototype.synchronize=function(){return l(this.onsendsuccess,this.onsenderror),this},n.prototype.pendingEventsCount=function(){return g("1self").events.length},n.prototype.visualize=function(a,b){return f.streamid=a,f.readToken=b,this},n.prototype.objectTags=function(a){return this.OBJECT_TAGS=a,this},n.prototype.actionTags=function(a){return this.ACTION_TAGS=a,this},n.prototype.sum=function(a){return this.FUNCTION_TYPE="sum("+a+")",this.SELECTED_PROP=a,this},n.prototype.mean=function(a){return this.FUNCTION_TYPE="mean("+a+")",this.SELECTED_PROP=a,this},n.prototype.count=function(){return this.FUNCTION_TYPE="count",this},n.prototype.barChart=function(){return this.CHART_TYPE="barchart",this},n.prototype.json=function(){return this.CHART_TYPE="type/json",this},n.prototype.url=function(){if(0==this.OBJECT_TAGS.length||0==this.ACTION_TAGS.length||!f.streamid||!this.FUNCTION_TYPE||!this.CHART_TYPE)throw new Error("Can't construct URL");var a=function(a){var b="";return a.forEach(function(a){b+=a+","}),b.slice(0,-1)},b=a(this.OBJECT_TAGS),d=a(this.ACTION_TAGS),e=c+"/v1/streams/"+f.streamid+"/events/"+b+"/"+d+"/"+this.FUNCTION_TYPE+"/daily/"+this.CHART_TYPE+"?readToken="+f.readToken;return(void 0!==this.BACKGROUND_COLOR||""!==this.BACKGROUND_COLOR)&&(e=e+"&bgColor="+this.BACKGROUND_COLOR),e},n});